# /etc/nginx/conf.d/dev.conf

# DNS inside Docker (needed for proxy_pass http://bcap:5175;)
resolver 127.0.0.11 ipv6=off;

# WebSocket upgrades
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen 80;
  server_name _;

  # -------------------------
  # Vite dev allowlist (bcap:5175) â€“ strip /bcap/static/ before proxying
  # -------------------------

  # HMR client script and WS
  location ^~ /bcap/static/@vite/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_set_header Host localhost;
    proxy_set_header Origin http://localhost:82;

    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Accept-Encoding "";   # avoid double-compression corruption
    proxy_buffering off;

    rewrite ^/bcap/static/(.*)$ /$1 break;
    proxy_pass http://bcap:5175;
  }

    # HMR + all dev assets (catch-all)
    location ^~ /bcap/@vite/ {
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection $connection_upgrade;
      proxy_set_header Host localhost;
      proxy_set_header Origin http://localhost:82;
      proxy_set_header Accept-Encoding "";   # avoid gzip corruption
      proxy_buffering off;

      rewrite ^/bcap/(.*)$ /$1 break;        # strip /bcap before hitting Vite
      proxy_pass http://bcap:5175;
    }
  # Vite ping endpoint
  location = /bcap/static/__vite_ping {
    proxy_set_header Host localhost;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Accept-Encoding "";
    proxy_buffering off;

    rewrite ^/bcap/static/(.*)$ /$1 break;
    proxy_pass http://bcap:5175;
  }

  # Virtual module ids
  location ^~ /bcap/static/@id/ {
    proxy_http_version 1.1;
    proxy_set_header Host localhost;
    proxy_set_header Accept-Encoding "";
    proxy_buffering off;

    rewrite ^/bcap/static/(.*)$ /$1 break;
    proxy_pass http://bcap:5175;
  }

  # File system exposure
  location ^~ /bcap/static/@fs/ {
    proxy_http_version 1.1;
    proxy_set_header Host localhost;
    proxy_set_header Accept-Encoding "";
    proxy_buffering off;

    rewrite ^/bcap/static/(.*)$ /$1 break;
    proxy_pass http://bcap:5175;
  }

  # Pre-bundled deps
  location ^~ /bcap/static/node_modules/.vite/ {
    proxy_http_version 1.1;
    proxy_set_header Host localhost;
    proxy_set_header Accept-Encoding "";
    proxy_buffering off;

    rewrite ^/bcap/static/(.*)$ /$1 break;
    proxy_pass http://bcap:5175;
  }

  # Direct node_modules assets (some pages reference these paths)
  location ^~ /bcap/static/node_modules/ {
    proxy_http_version 1.1;
    proxy_set_header Host localhost;
    proxy_set_header Accept-Encoding "";
    proxy_buffering off;

    rewrite ^/bcap/static/(.*)$ /$1 break;
    proxy_pass http://bcap:5175;
  }

  # Your local shims under vite-shims/
  location ^~ /bcap/static/vite-shims/ {
    proxy_http_version 1.1;
    proxy_set_header Host localhost;
    proxy_set_header Accept-Encoding "";
    proxy_buffering off;

    rewrite ^/bcap/static/(.*)$ /$1 break;
    proxy_pass http://bcap:5175;
  }

  # -------------------------
  # Default: Django app (keeps legacy static/plugins intact)
  # -------------------------
  location ^~ /bcap/static/ {
    proxy_pass http://bcap:80/bcap/static/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
  }

  location /bcap/ {
    proxy_pass http://bcap:80/bcap/;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
  }
}