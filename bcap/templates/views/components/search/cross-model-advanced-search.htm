{% load i18n %}
{% load static %}
{% load webpack_static from webpack_loader %}

<style>
    .cross-model-container {
        display: flex;
        gap: 16px;
        height: 100%;
        padding: 12px;
        position: relative;
    }

    .cross-model-main {
        flex: 1;
        min-width: 0;
        overflow-y: auto;
    }

    .cross-model-sidebar {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        max-height: 100%;
        max-width: 320px;
        min-width: 260px;
        overflow: hidden;
        width: 280px;
    }

    .cross-model-sidebar-header {
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        padding: 12px;
    }

    .cross-model-sidebar-title {
        color: #374151;
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    .cross-model-sidebar-search {
        position: relative;
    }

    .cross-model-sidebar-search input {
        background: #fff;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 13px;
        padding: 8px 32px 8px 10px;
        width: 100%;
    }

    .cross-model-sidebar-search input:focus {
        border-color: #2B4E6D;
        box-shadow: 0 0 0 2px rgba(43, 78, 109, 0.1);
        outline: none;
    }

    .cross-model-sidebar-search-clear {
        color: #9ca3af;
        cursor: pointer;
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
    }

    .cross-model-sidebar-search-clear:hover {
        color: #6b7280;
    }

    .cross-model-sidebar-content {
        flex: 1;
        overflow-y: auto;
    }

    .cross-model-graph-section {
        border-bottom: 1px solid #e5e7eb;
    }

    .cross-model-graph-section:last-child {
        border-bottom: none;
    }

    .cross-model-graph-header {
        align-items: center;
        background: #f9fafb;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        padding: 10px 12px;
        transition: background 0.15s;
        user-select: none;
    }

    .cross-model-graph-header:hover {
        background: #f3f4f6;
    }

    .cross-model-graph-name {
        color: #1f2937;
        font-size: 13px;
        font-weight: 600;
    }

    .cross-model-graph-toggle {
        color: #6b7280;
        font-size: 12px;
        transition: transform 0.2s;
    }

    .cross-model-graph-toggle.expanded {
        transform: rotate(90deg);
    }

    .cross-model-graph-cards {
        background: #fff;
    }

    .cross-model-card-option {
        align-items: center;
        border-bottom: 1px solid #f3f4f6;
        color: #374151;
        cursor: pointer;
        display: flex;
        font-size: 13px;
        justify-content: space-between;
        padding: 8px 12px 8px 24px;
        transition: background 0.15s;
    }

    .cross-model-card-option:last-child {
        border-bottom: none;
    }

    .cross-model-card-option:hover {
        background: #e8eff5;
    }

    .cross-model-card-option.used {
        color: #9ca3af;
        cursor: default;
    }

    .cross-model-card-option.used:hover {
        background: transparent;
    }

    .cross-model-card-option.draggable {
        cursor: grab;
    }

    .cross-model-card-option.draggable:active {
        cursor: grabbing;
    }

    .cross-model-card-option.dragging {
        opacity: 0.4;
    }

    .cross-model-card-option-drag-hint {
        color: #9ca3af;
        font-size: 11px;
    }

    .cross-model-add-group-option {
        align-items: center;
        border-bottom: 1px solid #e5e7eb;
        color: #2B4E6D;
        cursor: pointer;
        display: flex;
        font-size: 12px;
        font-weight: 500;
        gap: 6px;
        padding: 8px 12px 8px 24px;
        transition: background 0.15s;
    }

    .cross-model-add-group-option:hover {
        background: #e8eff5;
    }

    .cross-model-splash {
        align-items: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 60px 20px;
        text-align: center;
    }

    .cross-model-splash-icon {
        align-items: center;
        background: #2B4E6D;
        border-radius: 50%;
        color: #fff;
        display: flex;
        font-size: 32px;
        height: 80px;
        justify-content: center;
        margin-bottom: 20px;
        width: 80px;
    }

    .cross-model-splash-title {
        color: #1f2937;
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .cross-model-splash-text {
        color: #6b7280;
        font-size: 14px;
        line-height: 1.5;
        max-width: 380px;
    }

    .cross-model-options-bar {
        align-items: center;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: space-between;
        margin-bottom: 16px;
        padding: 12px 16px;
    }

    .cross-model-options-left {
        align-items: center;
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
    }

    .cross-model-option-group {
        align-items: center;
        display: flex;
        gap: 8px;
    }

    .cross-model-option-label {
        color: #374151;
        font-size: 13px;
        font-weight: 500;
    }

    .cross-model-option-select {
        background: #fff;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        color: #1f2937;
        font-size: 13px;
        padding: 6px 10px;
    }

    .cross-model-option-select:focus {
        border-color: #2B4E6D;
        box-shadow: 0 0 0 2px rgba(43, 78, 109, 0.1);
        outline: none;
    }

    .cross-model-strict-mode {
        align-items: center;
        display: flex;
        gap: 6px;
    }

    .cross-model-strict-mode input[type="checkbox"] {
        accent-color: #2B4E6D;
        cursor: pointer;
        height: 16px;
        width: 16px;
    }

    .cross-model-strict-mode label {
        color: #374151;
        cursor: pointer;
        font-size: 13px;
        font-weight: 500;
        user-select: none;
    }

    .cross-model-strict-mode-help {
        color: #9ca3af;
        cursor: help;
        font-size: 14px;
    }

    .cross-model-remove-btn {
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 14px;
        padding: 4px 8px;
        transition: color 0.15s;
    }

    .cross-model-remove-btn:hover {
        color: #dc2626;
    }

    .cross-model-section {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        margin-bottom: 16px;
        overflow: hidden;
    }

    .cross-model-section-header {
        align-items: center;
        background: #2B4E6D;
        border-bottom: 1px solid #1f3a52;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        display: flex;
        gap: 10px;
        justify-content: space-between;
        padding: 12px 16px;
        transition: background 0.15s;
        user-select: none;
    }

    .cross-model-section-header:hover {
        background: #366089;
    }

    .cross-model-section-header.collapsed {
        border-bottom: none;
        border-radius: 8px;
    }

    .cross-model-section-header-left {
        align-items: center;
        display: flex;
        gap: 10px;
    }

    .cross-model-section-toggle {
        color: #9ca3af;
        font-size: 12px;
        transition: transform 0.2s;
    }

    .cross-model-section-toggle.collapsed {
        transform: rotate(-90deg);
    }

    .cross-model-section-icon {
        color: #fff;
        font-size: 12px;
    }

    .cross-model-section-name {
        color: #fff;
        font-size: 14px;
        font-weight: 600;
    }

    .cross-model-section-body {
        padding: 16px;
    }

    .cross-model-group {
        background: #f9fafb;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
    }

    .cross-model-group:last-of-type {
        margin-bottom: 0;
    }

    .cross-model-group.drop-target {
        background-color: #e8eff5;
        border-color: #2B4E6D;
        box-shadow: 0 0 0 3px rgba(43, 78, 109, 0.2);
    }

    .cross-model-group-header {
        align-items: center;
        background: #fff;
        border-bottom: 1px solid #e5e7eb;
        border-radius: 4px 4px 0 0;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        padding: 10px 12px;
        transition: background 0.15s;
        user-select: none;
    }

    .cross-model-group-header:hover {
        background: #f9fafb;
    }

    .cross-model-group-header.collapsed {
        border-bottom: none;
        border-radius: 4px;
    }

    .cross-model-group-title {
        align-items: center;
        color: #374151;
        display: flex;
        font-size: 13px;
        font-weight: 500;
        gap: 8px;
    }

    .cross-model-group-toggle {
        color: #6b7280;
        font-size: 10px;
        transition: transform 0.2s;
    }

    .cross-model-group-toggle.collapsed {
        transform: rotate(-90deg);
    }

    .cross-model-group-controls {
        align-items: center;
        display: flex;
        gap: 12px;
    }

    .cross-model-group-match {
        align-items: center;
        display: flex;
        gap: 0;
    }

    .cross-model-group-match-label {
        color: #6b7280;
        font-size: 12px;
        margin-right: 8px;
    }

    .cross-model-group-match-btn {
        background: #f9fafb;
        border: 1px solid #d1d5db;
        color: #6b7280;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        padding: 4px 10px;
        transition: all 0.15s;
    }

    .cross-model-group-match-btn:first-of-type {
        border-radius: 4px 0 0 4px;
        border-right: none;
    }

    .cross-model-group-match-btn:last-of-type {
        border-radius: 0 4px 4px 0;
    }

    .cross-model-group-match-btn:hover {
        background: #f3f4f6;
    }

    .cross-model-group-match-btn.active {
        background: #2B4E6D;
        border-color: #2B4E6D;
        color: #fff;
    }

    .cross-model-group-body {
        min-height: 60px;
        padding: 12px;
    }

    .cross-model-group-body.collapsed {
        display: none;
    }

    .cross-model-group-empty {
        color: #9ca3af;
        font-size: 13px;
        font-style: italic;
        padding: 16px;
        text-align: center;
    }

    .cross-model-card-wrapper {
        margin-bottom: 12px;
        position: relative;
    }

    .cross-model-card-wrapper:last-child {
        margin-bottom: 0;
    }

    .cross-model-card-drop-indicator {
        background: #2B4E6D;
        border-radius: 2px;
        height: 3px;
        left: 0;
        position: absolute;
        right: 0;
        z-index: 10;
    }

    .cross-model-card-drop-indicator.before {
        top: -6px;
    }

    .cross-model-card-drop-indicator.after {
        bottom: -6px;
    }

    .cross-model-card {
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        margin-bottom: 10px;
        overflow: hidden;
        transition: box-shadow 0.15s, opacity 0.2s, transform 0.1s;
    }

    .cross-model-card:last-child {
        margin-bottom: 0;
    }

    .cross-model-card:hover {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .cross-model-card.dragging {
        opacity: 0.4;
        transform: scale(0.98);
    }

    .cross-model-card-header {
        align-items: center;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        padding: 10px 12px;
        transition: background 0.15s;
        user-select: none;
    }

    .cross-model-card-header:hover {
        background: #f3f4f6;
    }

    .cross-model-card-header-left {
        align-items: center;
        display: flex;
        flex: 1;
        gap: 8px;
        min-width: 0;
    }

    .cross-model-card-drag-handle {
        align-items: center;
        color: #9ca3af;
        cursor: grab;
        display: flex;
        font-size: 14px;
        padding: 4px 6px;
    }

    .cross-model-card-drag-handle:hover {
        color: #6b7280;
    }

    .cross-model-card-drag-handle:active {
        cursor: grabbing;
    }

    .cross-model-card-toggle {
        color: #6b7280;
        flex-shrink: 0;
        font-size: 10px;
        transition: transform 0.2s;
    }

    .cross-model-card-toggle.collapsed {
        transform: rotate(-90deg);
    }

    .cross-model-card-name {
        color: #1f2937;
        font-size: 13px;
        font-weight: 500;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .cross-model-card-header-right {
        align-items: center;
        display: flex;
        flex-shrink: 0;
        gap: 8px;
    }

    .cross-model-card-body {
        cursor: grab;
        padding: 12px;
    }

    .cross-model-card-body:active {
        cursor: grabbing;
    }

    .cross-model-card-body.collapsed {
        display: none;
    }

    .cross-model-filter {
        padding: 10px;
    }

    .cross-model-filter:not(:last-child) {
        margin-bottom: 12px;
    }

    .cross-model-filter-label {
        color: #1f2937;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 6px;
    }

    .cross-model-filter-widget {
        clear: both;
        display: flex;
        gap: 8px;
        overflow: visible;
    }

    .cross-model-filter-widget::after {
        clear: both;
        content: "";
        display: table;
    }

    .cross-model-filter-widget > * {
        margin-right: 0;
    }

    .cross-model-filter-unavailable {
        color: #9ca3af;
        font-size: 12px;
        font-style: italic;
    }

    .cross-model-operator {
        display: flex;
        gap: 0;
        margin: 16px 0;
        width: 100%;
    }

    .cross-model-operator-btn {
        background: #f9fafb;
        border: 1px solid #d1d5db;
        color: #6b7280;
        cursor: pointer;
        flex: 1;
        font-size: 11px;
        font-weight: 600;
        padding: 8px 12px;
        text-transform: uppercase;
        transition: all 0.15s;
    }

    .cross-model-operator-btn:first-child {
        border-radius: 4px 0 0 4px;
        border-right: none;
    }

    .cross-model-operator-btn:last-child {
        border-radius: 0 4px 4px 0;
    }

    .cross-model-operator-btn:hover {
        background: #f3f4f6;
    }

    .cross-model-operator-btn.active {
        background: #2B4E6D;
        border-color: #2B4E6D;
        color: #fff;
    }

    .cross-model-add-group-btn {
        background: transparent;
        border: 2px dashed #d1d5db;
        border-radius: 6px;
        color: #6b7280;
        cursor: pointer;
        font-size: 13px;
        margin-top: 12px;
        padding: 12px;
        text-align: center;
        transition: all 0.15s;
        width: 100%;
    }

    .cross-model-add-group-btn:hover {
        background: #f9fafb;
        border-color: #2B4E6D;
        color: #2B4E6D;
    }

    .cross-model-add-group-btn.drop-target {
        background: #e8eff5;
        border-color: #2B4E6D;
        border-style: solid;
        color: #2B4E6D;
    }

    .cross-model-loading-overlay {
        align-items: center;
        background: rgba(255, 255, 255, 0.9);
        bottom: 0;
        display: flex;
        flex-direction: column;
        justify-content: center;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        z-index: 100;
    }

    .cross-model-loading-spinner {
        animation: cross-model-spin 1s linear infinite;
        border: 4px solid #e5e7eb;
        border-radius: 50%;
        border-top-color: #2B4E6D;
        height: 48px;
        margin-bottom: 16px;
        width: 48px;
    }

    @keyframes cross-model-spin {
        to {
            transform: rotate(360deg);
        }
    }

    .cross-model-loading-text {
        color: #374151;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 4px;
    }

    .cross-model-loading-time {
        color: #6b7280;
        font-size: 13px;
    }
</style>

<!--ko let: { self: $data }-->
<div class="cross-model-container">

    <!-- Loading Overlay -->
    <!-- ko if: is_searching() -->
    <div class="cross-model-loading-overlay">
        <div class="cross-model-loading-spinner"></div>
        <div class="cross-model-loading-text">{% trans "Searching..." %}</div>
        <div class="cross-model-loading-time" data-bind="text: formatted_elapsed_time()"></div>
    </div>
    <!-- /ko -->

    <div class="cross-model-main">

        <!-- Splash Screen -->
        <!-- ko ifnot: has_filters() -->
        <div class="cross-model-splash">
            <div class="cross-model-splash-icon">
                <i class="fa fa-search-plus"></i>
            </div>
            <div class="cross-model-splash-title">{% trans "Cross-Model Advanced Search" %}</div>
            <div class="cross-model-splash-text">
                {% trans "Build complex queries across multiple resource models. Select cards from the sidebar to define your search criteria, or drag them directly into groups." %}
            </div>
        </div>
        <!-- /ko -->

        <!-- Options Bar -->
        <!-- ko if: has_filters() -->
        <div class="cross-model-options-bar">
            <div class="cross-model-options-left">
                <div class="cross-model-option-group">
                    <span class="cross-model-option-label">{% trans "Result Mode:" %}</span>
                    <select class="cross-model-option-select" data-bind="
                        value: translate_mode,
                        options: translate_mode_options,
                        optionsText: 'label',
                        optionsValue: 'value'
                    "></select>
                </div>

                <!-- Strict Mode Checkbox -->
                <!-- ko if: show_strict_mode_option() -->
                <div class="cross-model-strict-mode">
                    <input type="checkbox" id="cross-model-strict-mode-checkbox" data-bind="checked: strict_mode">
                    <label for="cross-model-strict-mode-checkbox">{% trans "Strict matching" %}</label>
                    <i class="fa fa-question-circle cross-model-strict-mode-help" title="{% trans "When enabled, only returns results that directly match the filter criteria. When disabled, returns all related results from matching resources." %}"></i>
                </div>
                <!-- /ko -->
            </div>

            <button class="cross-model-remove-btn" data-bind="click: clear" title="{% trans 'Clear All' %}">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <!-- /ko -->

        <!-- Resource Model Sections -->
        <!-- ko foreach: sections -->
        <!-- ko if: groups().length > 0 -->

        <div class="cross-model-section">
            <div class="cross-model-section-header" data-bind="click: function() { collapsed(!collapsed()); }, css: { 'collapsed': collapsed() }">
                <div class="cross-model-section-header-left">
                    <div class="cross-model-section-icon">
                        <i class="fa fa-database"></i>
                    </div>
                    <span class="cross-model-section-name" data-bind="text: graph_name"></span>
                </div>
                <i class="fa fa-chevron-down cross-model-section-toggle" data-bind="css: { 'collapsed': collapsed() }"></i>
            </div>

            <!-- ko ifnot: collapsed() -->
            <div class="cross-model-section-body">
                <!-- ko foreach: groups -->
                <div class="cross-model-group" data-bind="
                    css: { 'drop-target': self.is_drop_target($data) },
                    event: {
                        dragover: function(data, event) { return self.handle_drag_over($data, $parent, event); },
                        dragleave: function(data, event) { return self.handle_drag_leave($data, event); },
                        drop: function(data, event) { return self.handle_drop($data, $parent, event); }
                    }
                ">
                    <div class="cross-model-group-header" data-bind="click: function() { collapsed(!collapsed()); }, css: { 'collapsed': collapsed() }">
                        <span class="cross-model-group-title">
                            <i class="fa fa-chevron-down cross-model-group-toggle" data-bind="css: { 'collapsed': collapsed() }"></i>
                            {% trans "Group" %} <span data-bind="text: $index() + 1"></span>
                        </span>
                        <div class="cross-model-group-controls">
                            <div class="cross-model-group-match">
                                <span class="cross-model-group-match-label">{% trans "Match:" %}</span>
                                <button type="button" class="cross-model-group-match-btn" data-bind="
                                    click: function(data, event) { event.stopPropagation(); match('all'); },
                                    css: { 'active': match() === 'all' }
                                ">{% trans "All" %}</button>
                                <button type="button" class="cross-model-group-match-btn" data-bind="
                                    click: function(data, event) { event.stopPropagation(); match('any'); },
                                    css: { 'active': match() === 'any' }
                                ">{% trans "Any" %}</button>
                            </div>
                            <button class="cross-model-remove-btn" data-bind="click: function(data, event) { event.stopPropagation(); self.remove_group($parent, $data); }" title="{% trans 'Remove Group' %}">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="cross-model-group-body" data-bind="css: { 'collapsed': collapsed() }">
                        <!-- ko if: cards().length === 0 -->
                        <div class="cross-model-group-empty">
                            {% trans "No cards added. Select a card from the sidebar or drag a card here." %}
                        </div>
                        <!-- /ko -->

                        <!-- ko foreach: cards -->
                        <div class="cross-model-card-wrapper" data-bind="
                            event: {
                                dragover: function(data, event) { return self.handle_card_drag_over($data, $parent, $parents[1], event); }
                            }
                        ">
                            <!-- ko if: self.get_drop_indicator_position($data) === 'before' -->
                            <div class="cross-model-card-drop-indicator before"></div>
                            <!-- /ko -->

                            <div class="cross-model-card" data-bind="
                                css: { 'dragging': self.drag_data() && self.drag_data().card === $data }
                            ">
                                <div class="cross-model-card-header" data-bind="click: function() { collapsed(!collapsed()); }">
                                    <div class="cross-model-card-header-left">
                                        <span class="cross-model-card-drag-handle" draggable="true" title="{% trans 'Drag to move' %}" data-bind="
                                            event: {
                                                dragstart: function(data, event) { event.stopPropagation(); return self.handle_drag_start($data, $parent, $parents[1], event); },
                                                dragend: function(data, event) { return self.handle_drag_end($data, event); }
                                            },
                                            click: function(data, event) { event.stopPropagation(); }
                                        ">
                                            <i class="fa fa-bars"></i>
                                        </span>
                                        <i class="fa fa-chevron-down cross-model-card-toggle" data-bind="css: { 'collapsed': collapsed() }"></i>
                                        <span class="cross-model-card-name" data-bind="text: card_name"></span>
                                    </div>
                                    <div class="cross-model-card-header-right">
                                        <button class="cross-model-remove-btn" data-bind="click: function(data, event) { event.stopPropagation(); $parents[2].remove_card_from_group($parent, $data); }" title="{% trans 'Remove Card' %}">
                                            <i class="fa fa-times"></i>
                                        </button>
                                    </div>
                                </div>

                                <div class="cross-model-card-body" draggable="true" data-bind="
                                    css: { 'collapsed': collapsed() },
                                    event: {
                                        dragstart: function(data, event) { return self.handle_drag_start($data, $parent, $parents[1], event); },
                                        dragend: function(data, event) { return self.handle_drag_end($data, event); }
                                    }
                                ">
                                    <!-- ko foreach: nodes -->
                                    <!-- ko if: self.datatype_lookup[datatype] && self.datatype_lookup[datatype].configname && ko.components.isRegistered(self.datatype_lookup[datatype].configname) -->
                                    <div class="cross-model-filter">
                                        <div class="cross-model-filter-label" data-bind="text: label"></div>
                                        <div class="cross-model-filter-widget" data-bind="component: {
                                            name: self.datatype_lookup[datatype].configname,
                                            params: {
                                                search: true,
                                                filterValue: $parent.filters[nodeid],
                                                node: $data,
                                                datatype: self.datatype_lookup[datatype]
                                            }
                                        }"></div>
                                    </div>
                                    <!-- /ko -->
                                    <!-- ko ifnot: self.datatype_lookup[datatype] && self.datatype_lookup[datatype].configname && ko.components.isRegistered(self.datatype_lookup[datatype].configname) -->
                                    <div class="cross-model-filter">
                                        <div class="cross-model-filter-label" data-bind="text: label"></div>
                                        <div class="cross-model-filter-unavailable">{% trans "Search not available for this field type" %}</div>
                                    </div>
                                    <!-- /ko -->
                                    <!-- /ko -->
                                </div>
                            </div>

                            <!-- ko if: self.get_drop_indicator_position($data) === 'after' -->
                            <div class="cross-model-card-drop-indicator after"></div>
                            <!-- /ko -->
                        </div>
                        <!-- /ko -->
                    </div>
                </div>

                <!-- Operator between groups -->
                <!-- ko if: $index() < $parent.groups().length - 1 -->
                <div class="cross-model-operator">
                    <button type="button" class="cross-model-operator-btn" data-bind="
                        click: function() { operator_after('and'); },
                        css: { 'active': operator_after() === 'and' }
                    ">{% trans "AND" %}</button>
                    <button type="button" class="cross-model-operator-btn" data-bind="
                        click: function() { operator_after('or'); },
                        css: { 'active': operator_after() === 'or' }
                    ">{% trans "OR" %}</button>
                </div>
                <!-- /ko -->
                <!-- /ko -->

                <button class="cross-model-add-group-btn" data-bind="
                    click: function() { self.add_group($data); },
                    css: { 'drop-target': self.drag_over_add_group() === $data },
                    event: {
                        dragover: function(data, event) { return self.handle_add_group_drag_over($data, event); },
                        dragleave: function(data, event) { return self.handle_add_group_drag_leave($data, event); },
                        drop: function(data, event) { return self.handle_add_group_drop($data, event); }
                    }
                ">
                    <i class="fa fa-plus"></i> {% trans "Add Group" %}
                </button>
            </div>
            <!-- /ko -->
        </div>
        <!-- /ko -->
        <!-- /ko -->
    </div>

    <!-- Sidebar -->
    <div class="cross-model-sidebar">
        <div class="cross-model-sidebar-header">
            <div class="cross-model-sidebar-title">{% trans "Resource Models" %}</div>
            <div class="cross-model-sidebar-search">
                <input type="text" data-bind="
                    attr: { placeholder: '{% trans "Search cards..." %}' },
                    value: facet_filter_text,
                    valueUpdate: 'keyup'
                ">
                <span class="cross-model-sidebar-search-clear" data-bind="
                    click: function() { facet_filter_text(''); },
                    visible: facet_filter_text()
                ">
                    <i class="fa fa-times-circle"></i>
                </span>
            </div>
        </div>

        <div class="cross-model-sidebar-content">
            <!-- ko foreach: searchable_graphs -->
            <!-- ko if: filtered_cards().length > 0 -->
            <div class="cross-model-graph-section">
                <div class="cross-model-graph-header" data-bind="click: function() { collapsed(!collapsed()); }">
                    <span class="cross-model-graph-name" data-bind="text: name"></span>
                    <i class="fa fa-chevron-right cross-model-graph-toggle" data-bind="css: { 'expanded': !collapsed() }"></i>
                </div>

                <!-- ko ifnot: collapsed() -->
                <div class="cross-model-graph-cards">
                    <div class="cross-model-add-group-option" data-bind="click: function() {
                        var section = self.get_section_for_graph(graphid);
                        if (section) { self.add_group(section); }
                    }">
                        <i class="fa fa-plus"></i>
                        <span>{% trans "New Group" %}</span>
                    </div>

                    <!-- ko foreach: filtered_cards -->
                    <!-- ko if: self.is_card_used($data) -->
                    <div class="cross-model-card-option used">
                        <span data-bind="text: name"></span>
                    </div>
                    <!-- /ko -->
                    <!-- ko ifnot: self.is_card_used($data) -->
                    <div class="cross-model-card-option draggable" draggable="true" data-bind="
                        click: function() {
                            var section = self.get_section_for_graph($parent.graphid);
                            if (section && section.groups().length > 0) {
                                var last_group = section.groups()[section.groups().length - 1];
                                self.add_card_to_group(section, last_group, $data);
                            } else if (section) {
                                self.add_group(section);
                                var new_group = section.groups()[section.groups().length - 1];
                                self.add_card_to_group(section, new_group, $data);
                            }
                        },
                        css: { 'dragging': self.drag_data() && self.drag_data().source === 'sidebar' && self.drag_data().card_def === $data },
                        event: {
                            dragstart: function(data, event) { return self.handle_sidebar_drag_start($data, $parent, event); },
                            dragend: function(data, event) { return self.handle_sidebar_drag_end($data, event); }
                        }
                    ">
                        <span data-bind="text: name"></span>
                        <span class="cross-model-card-option-drag-hint"><i class="fa fa-bars"></i></span>
                    </div>
                    <!-- /ko -->
                    <!-- /ko -->
                </div>
                <!-- /ko -->
            </div>
            <!-- /ko -->
            <!-- /ko -->
        </div>
    </div>
</div>
<!--/ko-->
