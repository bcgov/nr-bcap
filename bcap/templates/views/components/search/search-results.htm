{% load static %}
{% load template_tags %}
{% load i18n %}

<div
    id="translation-state-banner"
    style="display: none; padding: 8px 10px; background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 4px; margin-bottom: 10px;"
>
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="font-size: 0.85em;">
            <span id="translation-state-text"></span>
        </div>
        <button
            id="clear-translation-banner-btn"
            class="btn btn-sm btn-outline-secondary"
            style="margin-left: 10px;"
            title="{% trans "Clear Translation" %}"
        >
            <i class="fa fa-times"></i>
        </button>
    </div>
</div>

<div
    class="site-translator-container"
    style="padding: 10px; border-bottom: 1px solid #ddd; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;"
>
    <select
        id="target-resource-type"
        class="form-control input-sm"
        style="width: auto; min-width: 200px;"
    >
        <option value="">{% trans "Loading..." %}</option>
    </select>

    <button
        id="translate-to-resource-type-btn"
        class="btn btn-primary btn-sm"
        title="{% trans 'Convert current search results to their related resources of the selected type' %}"
    >
        <i class="fa fa-exchange"></i> {% trans "Translate" %}
    </button>

    <span id="translate-status" style="margin-left: 10px; display: none;"></span>
</div>

<script>
(function() {
    let translation_state = {
        original_query: null,
        chain: [],
        source_mapping: {}
    };

    function get_csrf_token() {
        let cookie_value = null;
        if (document.cookie && document.cookie !== "") {
            let cookies = document.cookie.split(";");
            for (let i = 0; i < cookies.length; i++) {
                let cookie = cookies[i].trim();
                if (cookie.substring(0, 10) === "csrftoken=") {
                    cookie_value = decodeURIComponent(cookie.substring(10));
                    break;
                }
            }
        }
        return cookie_value;
    }

    function get_shared_state() {
        let search_results_el = document.getElementById("search-results-list");
        if (!search_results_el) {
            return null;
        }
        let context = ko.contextFor(search_results_el);
        if (context && context.$root && context.$root.sharedStateObject) {
            return context.$root.sharedStateObject;
        }
        return null;
    }

    function update_translation_banner() {
        let banner = document.getElementById("translation-state-banner");
        let state_text = document.getElementById("translation-state-text");

        if (!translation_state.chain || translation_state.chain.length === 0) {
            banner.style.display = "none";
            return;
        }

        banner.style.display = "block";

        let last_step = translation_state.chain[translation_state.chain.length - 1];

        state_text.textContent = "Translated " + last_step.original_count + " " + last_step.source_name + "(s) to " + last_step.count + " " + last_step.target_name + "(s).";
    }

    function clear_translation() {
        let shared_state = get_shared_state();
        if (!shared_state) {
            console.error("Could not get shared state");
            return;
        }

        let original = translation_state.original_query;

        translation_state.original_query = null;
        translation_state.chain = [];
        translation_state.source_mapping = {};

        if (original && Object.keys(original).length > 0) {
            shared_state.query(original);
        } else {
            shared_state.query({});
        }

        update_translation_banner();
    }

    function load_resource_types() {
        let select = document.getElementById("target-resource-type");
        let base_url = window.location.pathname.split("/search")[0];

        fetch(base_url + "/api/translatable-resource-types", {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            select.innerHTML = "";

            if (data.status === "success" && data.resource_types) {
                data.resource_types.forEach(function(resource_type) {
                    let option = document.createElement("option");
                    option.value = resource_type.graphid;
                    option.textContent = resource_type.name;
                    select.appendChild(option);
                });
            } else {
                let option = document.createElement("option");
                option.value = "";
                option.textContent = "No resource types available";
                select.appendChild(option);
            }

            update_translation_banner();
        })
        .catch(function(error) {
            console.error("Error loading resource types:", error);
            select.innerHTML = "<option value=''>Error loading types</option>";
        });
    }

    function translate_to_resource_type() {
        let btn = document.getElementById("translate-to-resource-type-btn");
        let status = document.getElementById("translate-status");
        let select = document.getElementById("target-resource-type");
        let target_graph_id = select.value;

        if (!target_graph_id) {
            status.style.display = "inline";
            status.style.color = "orange";
            status.textContent = "Please select a target resource type.";
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Translating...';
        status.style.display = "none";

        let shared_state = get_shared_state();
        if (!shared_state) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa fa-exchange"></i> Translate';
            status.style.display = "inline";
            status.style.color = "red";
            status.textContent = "Could not access search state.";
            return;
        }

        let current_query = shared_state.query();

        let form_data = new FormData();
        form_data.append("target_graph_id", target_graph_id);
        form_data.append("csrfmiddlewaretoken", get_csrf_token());

        if (translation_state.original_query) {
            Object.keys(translation_state.original_query).forEach(function(key) {
                if (key !== "paging-filter" && key !== "ids") {
                    form_data.append(key, translation_state.original_query[key]);
                }
            });
        } else {
            Object.keys(current_query).forEach(function(key) {
                if (key !== "paging-filter" && key !== "ids") {
                    form_data.append(key, current_query[key]);
                }
            });

            let original = {};
            Object.keys(current_query).forEach(function(key) {
                if (key !== "ids" && key !== "paging-filter") {
                    original[key] = current_query[key];
                }
            });
            translation_state.original_query = original;
        }

        let base_url = window.location.pathname.split("/search")[0];
        fetch(base_url + "/api/translate-to-resource-type", {
            method: "POST",
            body: form_data,
            credentials: "same-origin"
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(data) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa fa-exchange"></i> Translate';

            if (data.status === "success" && data.resource_ids && data.resource_ids.length > 0) {
                status.style.display = "none";

                translation_state.source_mapping = data.source_mapping || {};

                translation_state.chain = [{
                    source_name: data.source_resource_type_name || "search results",
                    target_name: data.target_resource_type_name,
                    count: data.total_translated,
                    original_count: data.original_count
                }];

                let paging_filter = shared_state.getFilter("paging-filter");
                if (paging_filter) {
                    paging_filter.userRequestedNewPage = true;
                    paging_filter.preventLoop = true;
                }

                let new_query = {
                    "ids": JSON.stringify(data.resource_ids),
                    "paging-filter": 1
                };
                shared_state.query(new_query);

                if (paging_filter) {
                    paging_filter.page(1);
                }

                update_translation_banner();
            } else {
                status.style.display = "inline";
                status.style.color = "orange";
                status.textContent = "No related resources found for the selected type.";
            }
        })
        .catch(function(error) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fa fa-exchange"></i> Translate';
            status.style.display = "inline";
            status.style.color = "red";
            status.textContent = "An error occurred.";
            console.error("Translation error:", error);
        });
    }

    window.get_translation_source = function(resourceinstanceid) {
        let sources = translation_state.source_mapping[resourceinstanceid];
        if (sources && sources.length > 0) {
            return sources.join(", ");
        }
        return null;
    };

    let translate_btn = document.getElementById("translate-to-resource-type-btn");
    if (translate_btn) {
        translate_btn.addEventListener("click", translate_to_resource_type);
    }

    let clear_btn = document.getElementById("clear-translation-banner-btn");
    if (clear_btn) {
        clear_btn.addEventListener("click", clear_translation);
    }

    load_resource_types();
})();
</script>

<div id="search-results-list" style="display: none;" role="list" tabindex="-1" data-bind="foreach: results, visible: true,
    attr: {'aria-label': $root.translations.searchResults}
">

    <div class="search-listing" role="listitem" data-bind="event: { mouseover: mouseoverInstance, mouseout: mouseoverInstance('')}, css: {'selected': selected()}">
        <div style="display: flex">
            <div class="search-thumbnail-container">
                <div
                    style="display: flex; align-items: center; margin: 10px; background-color: lightgrey;"
                    data-bind="
                        visible: thumbnail,
                        event: {
                            mouseover: mouseoverThumbnail,
                            mouseout: mouseoutThumbnail,
                        }
                    "
                >
                    <img class="search-thumbnail-image" data-bind="attr:{src: thumbnail}" alt="">
                </div>
                <img class="search-hover-image" data-bind="attr:{src: thumbnail}" alt="">
            </div>
            <div style="flex: 1">
                <p
                    class="search-listing-title"
                    data-bind="css: {'i18n-alt': $parent.alternativelanguage}"
                >
                    <!--ko if: canEdit -->
                    <a class="search-candidate-title" href="#" data-bind="onEnterkeyClick, onSpaceClick,
                        click:  $parent.viewReport.bind($parent),
                        attr: {'aria-label': $root.translations.viewResourceReport(displayname)},
                    ">
                        <i class="search-listing-icon" data-bind="css: iconclass"></i>
                        <span data-bind="html: displayname"></span>
                    </a>
                    <!--/ko-->
                    <!--ko if: !canEdit -->
                    <span class="search-candidate-title" data-bind="attr: {'aria-label': $root.translations.viewResourceReport(displayname)}">
                        <i class="search-listing-icon" data-bind="css: iconclass"></i>
                        <span data-bind="html: displayname"></span>
                    </span>
                    <!--/ko-->
                </p>

                <!--ko if: window.get_translation_source && window.get_translation_source(resourceinstanceid) -->
                <div
                    class="search-listing-source"
                    style="font-size: 0.8em; color: #155724; background-color: #d4edda; padding: 6px 12px; border-radius: 3px; margin: 8px 0; display: inline-block;"
                >
                    <i class="fa fa-link" style="margin-right: 6px;"></i>
                    Related to: <strong data-bind="text: window.get_translation_source(resourceinstanceid)"></strong>
                </div>
                <!--/ko-->

                <div class="search-listing-body" data-bind="html: displaydescription">

                </div>
            </div>
        </div>
        <div class="search-listing-footer">
            <div style="flex-grow: 1;">
                <!--ko if: provisional_resource == 'true' -->
                <span class="provisional-edits">
                    <i class="fa fa-exclamation-circle"></i>
                    <span data-bind="text: $root.translations.provisional"></span>
                </span>
                <!--/ko-->

                <!--ko if: provisional_resource == 'partial' && $parent.userIsReviewer -->
                <span class="provisional-edits">
                    <i class="fa fa-exclamation-circle"></i>
                    <span data-bind="text: $root.translations.provisional"></span>
                </span>
                <!--/ko-->

                <!-- ko if: !!$parent.details -->
                <button class="search-candidate-link" data-bind="onEnterkeyClick, onSpaceClick, click: showDetails,
                    attr: {'aria-label': $root.translations.viewResourceDetails(displayname)},
                ">
                    <i class="fa fa-info-circle"></i>
                    <span data-bind="text: $root.translations.details"></span>
                </button>
                <!-- /ko -->

                <!--ko if: canEdit -->
                <a class="search-candidate-link" href="#" data-bind="onEnterkeyClick, onSpaceClick, click: $parent.editResource.bind($parent),
                    attr: {'aria-label': $root.translations.editResource(displayname)},
                ">
                    <i class="ion-ios-refresh-empty"></i>
                    <span data-bind="text: $root.translations.edit"></span>
                </a>
                <!--/ko-->

                <!-- ko if: !$parent.mapFilter -->
                <button class="search-candidate-link" data-bind="visible: point, click: mapLinkClicked,
                    attr:{'aria-label': $root.translations.viewMap},
                ">
                    <i class="fa fa-map-marker"></i>
                    <span data-bind="text: $root.translations.map"></span>
                </button>
                <!-- /ko -->
            </div>

            <div>
                <!--ko ifnot: $root.resourceEditorContext -->
                    <!--ko if: !!$parent.relatedResourcesManager && canRead -->
                    <button class="search-candidate-link" data-bind="onEnterkeyClick, onSpaceClick, click: showrelated,
                        attr: {'aria-label': $root.translations.viewRelatedResources(displayname)},
                    ">
                        <i class="fa fa-code-fork"></i>
                        <span data-bind="text: $root.translations.relatedResources"></span>
                    </button>
                    <!--/ko-->
                <!--/ko-->

                <!--ko if: $root.resourceEditorContext -->
                    <!--ko if: relatable & $root.editingInstanceId != resourceinstanceid -->
                    <button class="search-candidate-link" data-bind="onEnterkeyClick, onSpaceClick, click: function(val){relationshipcandidacy(val); showrelated()},
                        attr: {'aria-label': $root.translations.viewRelatedResources(displayname)},
                    ">
                        <i class="fa fa-code-fork"></i>
                        <span data-bind="text: $root.translations.relateResource"></span>
                    </button>
                    <!--/ko-->
                    <!--ko if: relatable == false || $root.editingInstanceId == resourceinstanceid -->
                    <span class="search-candidate-link unrelatable-search-result">
                        <i class="fa fa-code-fork"></i>
                        <span data-bind="text: $root.translations.cannotBeRelated"></span>
                    </span>
                    <!--/ko-->
                <!--/ko-->
            </div>
        </div>
    </div>

</div>
